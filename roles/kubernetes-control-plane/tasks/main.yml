- name: Pre configure control plane hooks
  loop: "{{ kubernetes_hookfiles.pre_configure_control_planes }}"
  loop_control:
    loop_var: hook
  when:
  - kubernetes_hookfiles.pre_configure_control_planes is defined
  ansible.builtin.include_tasks: "{{ hook }}"

- name: Configure control plane files
  ansible.builtin.include_tasks:
    file: configure-control-plane.yml

- name: Create etcd group
  ansible.builtin.group:
    gid: 500
    name: etcd
    system: true

- name: Create etcd user
  ansible.builtin.user:
    comment: "etcd user"
    create_home: false
    group: etcd
    name: etcd
    shell: /bin/false
    system: true
    uid: 500

- name: Renew K8S control plane certificates monthly systemd timer
  when: kubernetes_manage_cert_renewal
  ansible.builtin.systemd_service:
    daemon_reload: true
    enabled: true
    name: k8s-certs-renew.timer
    state: started

- name: Install git (required for Helm install script)
  when: kubernetes_install_helm
  ansible.builtin.package:
    name: git
    state: present

- name: Download Helm install script
  when: kubernetes_install_helm
  ansible.builtin.get_url:
    dest: /tmp/install_helm.sh
    group: root
    mode: '0755'
    owner: root
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4

- name: Install Helm
  changed_when: true
  environment:
    HELM_INSTALL_DIR: /usr/bin
  when: kubernetes_install_helm
  ansible.builtin.shell:
    cmd: /tmp/install_helm.sh
    creates: /usr/bin/helm
    executable: /bin/bash

- name: Remove Helm install script
  when: kubernetes_install_helm
  ansible.builtin.file:
    path: /tmp/install_helm.sh
    state: absent

- name: Install Kustomize
  when: kubernetes_install_kustomize
  block:
  - name: Download Kustomize
    ansible.builtin.get_url:
      dest: /tmp/install_kustomize.sh
      group: root
      mode: '0755'
      owner: root
      url: https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh

  - name: Install Kustomize
    ansible.builtin.shell:
      cmd: |
        set -eo pipefail
        /tmp/install_kustomize.sh
        mv kustomize /usr/bin/kustomize
      creates: /usr/bin/kustomize
      executable: /bin/bash

  - name: Remove Kustomize install script
    ansible.builtin.file:
      path: /tmp/install_kustomize.sh
      state: absent

- name: Post configure control plane hooks
  loop: "{{ kubernetes_hookfiles.post_configure_control_planes }}"
  loop_control:
    loop_var: hook
  when:
  - kubernetes_hookfiles.post_configure_control_planes is defined
  ansible.builtin.include_tasks: "{{ hook }}"

- name: Initialize control plane
  delegate_to: "{{ first_kube_control_plane }}"
  run_once: true
  when:
  - kubernetes_initialize_ran is not defined or
    not kubernetes_initialize_ran
  ansible.builtin.import_tasks:
    file: initialize-control-plane.yml

- name: Set kubernetes_initialize_ran to true
  delegate_facts: true
  delegate_to: "{{ node }}"
  loop: "{{ ansible_play_hosts }}"
  loop_control:
    loop_var: node
  run_once: true
  ansible.builtin.set_fact:
    kubernetes_initialize_ran: true

- name: Get Join token
  changed_when: true
  delegate_to: "{{ first_kube_control_plane }}"
  register: temp_token
  run_once: true
  ansible.builtin.command:
    cmd: kubeadm token create --kubeconfig /etc/kubernetes/admin.conf

- name: Get CA certificate hash
  changed_when: false
  delegate_to: "{{ first_kube_control_plane }}"
  register: cluster_ca_cert_hash_temp
  run_once: true
  ansible.builtin.shell:
    cmd: |
      set -eo pipefail
      openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
      openssl rsa -pubin -outform der 2>/dev/null | \
      openssl dgst -sha256 -hex | sed 's/^.* //'
    executable: /usr/bin/bash

- name: Upload certificates so they are fresh and not expired
  changed_when: true
  delegate_to: "{{ first_kube_control_plane }}"
  register: kubeadm_upload_cert
  run_once: true
  ansible.builtin.command:
    cmd: kubeadm init phase --config {{ kubernetes_config_directory }}/kubeadm.yaml upload-certs --upload-certs

- name: Set facts
  run_once: true
  ansible.builtin.set_fact:
    cluster_ca_cert_hash: "sha256:{{ cluster_ca_cert_hash_temp.stdout }}"
    join_token: "{{ temp_token.stdout }}"
    kubeadm_upload_token: "{{ kubeadm_upload_cert.stdout_lines[-1] | trim }}"

- name: Configure additional control planes
  when:
  - first_kube_control_plane != inventory_hostname
  - inventory_hostname in groups['control_planes']
  ansible.builtin.import_tasks:
    file: secondary-control-plane.yml

# Get an updated list of nodes in the cluster
- name: Get nodes in the cluster
  changed_when: false
  delegate_to: "{{ first_kube_control_plane }}"
  register: kubernetes_nodes
  ansible.builtin.command:
    cmd: kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes -o custom-columns=NAME:.metadata.name --no-headers

- name: Set the node name fact
  ansible.builtin.set_fact:
    kubernetes_node_name: "{% if inventory_hostname in kubernetes_nodes.stdout_lines %}{{ inventory_hostname }}{% elif inventory_hostname_short in kubernetes_nodes.stdout_lines %}{{ inventory_hostname_short }}{% endif %}"

- name: Fail if Kubernetes node name could not be determined
  when:
  - kubernetes_node_name is not defined or
    kubernetes_node_name | length == 0
  ansible.builtin.fail:
    msg: >-
      Could not determine Kubernetes node name for host {{ inventory_hostname }}.
      Ensure either '{{ inventory_hostname }}' or '{{ inventory_hostname_short }}' appears
      in the list of Kubernetes nodes: {{ kubernetes_nodes.stdout_lines | default('') | join(', ') }}

# This kubectl command returns all certificate signing requests for the node, one per line
- name: Get certificate signing requests
  changed_when: false
  delegate_to: "{{ first_kube_control_plane }}"
  register: csr_check
  ansible.builtin.command:
    cmd: kubectl --kubeconfig /etc/kubernetes/admin.conf get csr -o jsonpath='{range .items[?(@.spec.username=="system:node:{{ kubernetes_node_name }}")]}{.metadata.name}{"\n"}{end}'

- name: Approve certificate signing requests
  changed_when: true
  delegate_to: "{{ first_kube_control_plane }}"
  loop: "{{ csr_check.stdout_lines }}"
  loop_control:
    loop_var: csr_name
  when:
  - csr_check.stdout_lines | length > 0
  ansible.builtin.command:
    cmd: kubectl --kubeconfig /etc/kubernetes/admin.conf certificate approve "{{ csr_name }}"
