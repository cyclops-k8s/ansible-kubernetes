- name: Pre proxy configuration hooks
  when: kubernetes_hookfiles.pre_proxies is defined
  with_items: "{{ kubernetes_hookfiles.pre_proxies }}"
  ansible.builtin.include_tasks: "{{ item }}"

- name: Validate Proxy Configuration
  ansible.builtin.assert:
    that:
    - vrrp_interface != None
    - vrrp_password != None
    - vrrp_virtual_router_id != None

- name: Copy haproxy.cfg
  ansible.builtin.template:
    dest: /etc/kubernetes/config/haproxy.cfg
    group: root
    mode: '0644'
    owner: root
    src: "{{ kubernetes_proxy_haproxy_config_file }}"

- name: Copy kube-apiserver-proxy manifest
  ansible.builtin.template:
    dest: /etc/kubernetes/manifests/kube-apiserver-proxy.yaml
    group: root
    mode: '0644'
    owner: root
    src: api-server-proxy.yaml.j2

- name: Install keepalived
  ansible.builtin.package:
    name:
    - keepalived
    state: present

- name: Copy keepalived.conf
  ansible.builtin.template:
    dest: /etc/keepalived/keepalived.conf
    mode: '0644'
    owner: root
    src: "{{ kubernetes_proxy_keepalived_config_file }}"

- name: Enable keepalived
  ansible.builtin.systemd_service:
    enabled: true
    name: keepalived

- name: Restart keepalived
  ansible.builtin.systemd_service:
    daemon_reload: true
    name: keepalived
    state: restarted

- name: Set the net.ipv4.ip_nonlocal_bind=1 sysctl
  ansible.builtin.sysctl:
    name: net.ipv4.ip_nonlocal_bind
    reload: true
    state: present
    sysctl_file: /etc/sysctl.d/99-non-local-bind.conf
    value: '1'

- name: Post proxy configuration hooks
  when: kubernetes_hookfiles.post_proxies is defined
  with_items: "{{ kubernetes_hookfiles.post_proxies }}"
  ansible.builtin.include_tasks: "{{ item }}"
